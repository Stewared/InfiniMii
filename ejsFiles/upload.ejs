<!DOCTYPE html>
<html>
    <head>
        <%
        const pageTitle = 'Upload Mii Character - InfiniMii';
        const pageDesc = 'Share your custom Mii characters with the InfiniMii community. Upload Miis from Wii, 3DS, Wii U, or scan QR codes to contribute to our growing repository.';
        const canonicalUrl = `${baseUrl}/upload`;
        const keywords = 'upload mii, share mii, mii community, submit mii character';
        %>
        <%- include('metaTags') %>
        <%- include('structuredData') %>
        <link rel='stylesheet' href="/global.css">
        <link rel="stylesheet" href="/utilityPages.css">
        <link rel="stylesheet" href="/upload.css">
    </head>
    <body>
        <%- include('globalStyle') %>
        <%- include('header') %>
        <%- include('accountDisplay') %>
        <main class='content' role="main">
            <%- include('sidebar') %>
            <article class='upload utility-container'>
                <fieldset>
                    <legend>Upload a Mii to InfiniMii</legend>
                    <div id="error-message" style="display: none; color: red; background: #ffe6e6; border: 1px solid #ff9999; padding: 10px; border-radius: 5px; margin-bottom: 15px;"></div>
                        <% if (fromAmiibo) { %>
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; color: white;">
                                <h4 style="margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px;">
                                    Uploading Mii Extracted from Amiibo
                                </h4>
                                <div style="display: flex; align-items: center; gap: 20px; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                                    <img src="/miiImgs/<%= fromAmiibo.id %>.png" 
                                        style="width: 100px; height: 100px; border-radius: 8px; border: 3px solid white; box-shadow: 0 4px 8px rgba(0,0,0,0.3);">
                                    <div>
                                        <p style="margin: 0 0 8px 0; font-size: 18px; font-weight: bold;"><%= fromAmiibo.name %></p>
                                        <p style="margin: 0; opacity: 0.9;">Creator: <%= fromAmiibo.creator %></p>
                                        <p style="margin: 8px 0 0 0; font-size: 14px; opacity: 0.8;">
                                            Edit the description below, then click Upload to add this Mii to your private collection.
                                        </p>
                                    </div>
                                </div>
                                <input type="hidden" name="fromAmiibo" value="<%= fromAmiibo.id %>">
                            </div>
                        <% } %>
                        <div class="upload-instructions">
                            <h3>Before You Upload:</h3>
                            <ul>
                                <li>Ensure your Mii is in a supported format (Wii .mii, 3DS/Wii U .bin, or QR code image)</li>
                                <li>Provide a clear, descriptive name and description</li>
                                <li>Be respectful and follow community guidelines</li>
                                <li>Miis uploaded are private to start, you can publish them to the public <a href="/MyPrivateMiis">here</a>.</li>
                            </ul>
                        </div>
                        
                        <div class="upload-tabs">
                            <button class="tab-button active" onclick="switchTab('file')">üìÅ File Upload</button>
                            <button class="tab-button" onclick="switchTab('studio')">üé® Mii Studio</button>
                            <button class="tab-button" onclick="switchTab('qr')">üì∏ Scan QR Code</button>
                        </div>
                        
                        <!-- File Upload Tab -->
                        <div id="fileTab" class="tab-content active">
                            <form action="/uploadMii" method="post" enctype="multipart/form-data" id='uploadForm'>
                                <% if (!fromAmiibo) { %>
                                    <div class="radio-group">
                                        <div class="radio-option">
                                            <input type="radio" value="3ds" name="type" id="type3ds" checked>
                                            <label for="type3ds">3DS/Wii U QR Code</label>
                                        </div>
                                        <div class="radio-option">
                                            <input type="radio" value="3dsbin" name="type" id="type3dsbin">
                                            <label for="type3dsbin">3DS Bin (Encrypted/Decrypted)</label>
                                        </div>
                                        <div class="radio-option">
                                            <input type="radio" value="wii" name="type" id="typewii">
                                            <label for="typewii">Wii Bin</label>
                                        </div>
                                    </div>
                                    
                                    <div class="format-hint">
                                        <strong>Supported formats:</strong><br>
                                        ‚Ä¢ 3DS/Wii U: .jpg, .png QR codes<br>
                                        ‚Ä¢ 3DS Bin: .bin files (both encrypted and decrypted)<br>
                                        ‚Ä¢ Wii: .mii, .bin files
                                    </div>
                                    
                                    <label for="mii-upload" hidden>Upload Mii File:</label>
                                    <input type="file" name="mii" accept=".mii,.bin,.png,.jpg" required id="mii-upload">
                                <% } else { %>
                                    <input type="hidden" name="type" value="3dsbin_amiibo">
                                <% } %>
                                
                                <label for="mii-description">Description (Max 250 charactrs):</label>
                                <textarea maxlength="250" rows="5" placeholder="Description..." name="desc" id="mii-description" required aria-required="true"></textarea>
                                
                                <% if(isResearcher) { %>
                                    <div class="official-section">
                                        <input type="checkbox" name="official" id="officialCheckbox" onchange="toggleOfficialFields()"> 
                                        <label for="official">
                                            <b>This is an exact copy of a Mii</b> that appears in a Nintendo game/promotion officially
                                        </label>
                                        
                                        <div id="officialFields" style="display: none; margin-top: 15px; padding: 15px; background: #f0f8ff; border-radius: 8px; border: 2px solid #bbdefb;">
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                                <h4 style="margin: 0;">Official Mii Categories:</h4>
                                                <a href="/manageCategories" target="_blank" class="manage-cats-link">
                                                    üóÇÔ∏è Manage Categories
                                                </a>
                                            </div>
                                            
                                            <p style="color: #666; margin-bottom: 15px; font-size: 0.95em;">
                                                Select all categories that apply. Only leaf categories (those without children) can be selected.
                                            </p>
                                            
                                            <div id="categoriesContainer">
                                                <p style="text-align: center; color: #666;">Loading categories...</p>
                                            </div>
                                            
                                            <p style="margin-top: 15px; font-size: 0.9em; color: #666;">
                                                <strong>Note:</strong> Please mention specific details in the description above.
                                                Incorrectly marking a Mii as official may result in it being removed.
                                            </p>
                                        </div>
                                    </div>
                                    
                                    <script>
                                        let officialCategories = [];
                                        let selectedPaths = new Set();
                                        let expandedNodes = new Set();
                                        
                                        function toggleOfficialFields() {
                                            const checkbox = document.getElementById('officialCheckbox');
                                            const fields = document.getElementById('officialFields');
                                            fields.style.display = checkbox.checked ? 'block' : 'none';
                                            
                                            if (checkbox.checked && officialCategories.length === 0) {
                                                loadCategories();
                                            }
                                        }
                                        
                                        async function loadCategories() {
                                            try {
                                                const response = await fetch('/getOfficialCategories');
                                                const data = await response.json();
                                                
                                                if (!data.error) {
                                                    officialCategories = data.categories;
                                                    renderCategoryTree();
                                                } else {
                                                    document.getElementById('categoriesContainer').innerHTML = 
                                                        '<p style="color: red;">Error loading categories</p>';
                                                }
                                            } catch (error) {
                                                console.error('Error loading categories:', error);
                                                document.getElementById('categoriesContainer').innerHTML = 
                                                    '<p style="color: red;">Error loading categories</p>';
                                            }
                                        }
                                        
                                        function renderCategoryTree() {
                                            const container = document.getElementById('categoriesContainer');
                                            
                                            if (officialCategories.length === 0) {
                                                container.innerHTML = '<p style="text-align: center; color: #666;">No categories available. <a href="/manageCategories" target="_blank">Create some!</a></p>';
                                                return;
                                            }
                                            
                                            container.innerHTML = '<div class="category-tree-upload">' + renderCategoryNodes(officialCategories) + '</div>';
                                        }
                                        
                                        function renderCategoryNodes(nodes, level = 0) {
                                            let html = '';
                                            
                                            nodes.forEach(node => {
                                                const hasChildren = node.children && node.children.length > 0;
                                                const isExpanded = expandedNodes.has(node.path);
                                                const isLeaf = !hasChildren;
                                                const isSelected = selectedPaths.has(node.path);
                                                const indent = level * 20;
                                                
                                                html += `
                                                    <div class="tree-node-upload" style="margin-left: ${indent}px;">
                                                        <div class="node-line" style="border-left: 3px solid ${node.color}">
                                                            ${hasChildren ? `
                                                                <span class="toggle-upload" onclick="toggleNodeUpload('${node.path}')">
                                                                    ${isExpanded ? '‚ñº' : '‚ñ∂'}
                                                                </span>
                                                            ` : '<span class="leaf-marker">‚Ä¢</span>'}
                                                            
                                                            ${isLeaf ? `
                                                                <label class="category-label-upload">
                                                                    <input type="checkbox" 
                                                                        name="categories" 
                                                                        value="${node.path}"
                                                                        ${isSelected ? 'checked' : ''}
                                                                        onchange="updateSelection('${node.path}', this.checked)">
                                                                    <span style="color: ${node.color}; font-weight: 500;">${node.name}</span>
                                                                </label>
                                                            ` : `
                                                                <span class="parent-name" style="color: ${node.color}; font-weight: 600;">
                                                                    ${node.name}
                                                                </span>
                                                            `}
                                                        </div>
                                                        
                                                        ${hasChildren && isExpanded ? `
                                                            <div class="children-upload">
                                                                ${renderCategoryNodes(node.children, level + 1)}
                                                            </div>
                                                        ` : ''}
                                                    </div>
                                                `;
                                            });
                                            
                                            return html;
                                        }
                                        
                                        function toggleNodeUpload(path) {
                                            if (expandedNodes.has(path)) {
                                                expandedNodes.delete(path);
                                            } else {
                                                expandedNodes.add(path);
                                            }
                                            renderCategoryTree();
                                        }
                                        
                                        function updateSelection(path, checked) {
                                            if (checked) {
                                                selectedPaths.add(path);
                                            } else {
                                                selectedPaths.delete(path);
                                            }
                                        }
                                    </script>
                                    
                                    <style>
                                        .manage-cats-link {
                                            background: #2196F3;
                                            color: white;
                                            padding: 6px 12px;
                                            border-radius: 6px;
                                            text-decoration: none;
                                            font-size: 0.9em;
                                            font-weight: bold;
                                            transition: background 0.3s;
                                        }
                                        
                                        .manage-cats-link:hover {
                                            background: #0b7dda;
                                        }
                                        
                                        .category-tree-upload {
                                            background: white;
                                            border: 1px solid #ddd;
                                            border-radius: 8px;
                                            padding: 15px;
                                            max-height: 400px;
                                            overflow-y: auto;
                                        }
                                        
                                        .tree-node-upload {
                                            margin-bottom: 4px;
                                        }
                                        
                                        .node-line {
                                            display: flex;
                                            align-items: center;
                                            padding: 8px;
                                            background: #f9f9f9;
                                            border-radius: 6px;
                                            border-left-width: 3px;
                                            margin-bottom: 4px;
                                        }
                                        
                                        .toggle-upload {
                                            cursor: pointer;
                                            user-select: none;
                                            margin-right: 8px;
                                            width: 18px;
                                            color: #666;
                                            font-size: 0.85em;
                                        }
                                        
                                        .toggle-upload:hover {
                                            color: #000;
                                        }
                                        
                                        .leaf-marker {
                                            display: inline-block;
                                            width: 18px;
                                            text-align: center;
                                            margin-right: 8px;
                                            color: #ccc;
                                            font-size: 0.7em;
                                        }
                                        
                                        .category-label-upload {
                                            display: flex;
                                            align-items: center;
                                            gap: 8px;
                                            cursor: pointer;
                                            flex: 1;
                                        }
                                        
                                        .category-label-upload:hover {
                                            opacity: 0.8;
                                        }
                                        
                                        .category-label-upload input[type="checkbox"] {
                                            cursor: pointer;
                                        }
                                        
                                        .parent-name {
                                            font-size: 1.05em;
                                        }
                                        
                                        .children-upload {
                                            margin-top: 4px;
                                        }
                                    </style>
                                <% } %>
                                
                                <input type="submit" value="Upload">
                            </form>
                        </div>

                        <!-- Studio Tab -->
                        <div id="studioTab" class="tab-content">
                            <form action="/uploadStudioMii" method="post" id="studioForm">
                                <p style="color: var(--text-2); margin-bottom: 1rem;">
                                    Paste your Mii Studio code
                                </p>
                                
                                <label for="studioCode">Studio Code:</label>
                                <input type="text" name="studioCode" id="studioCode" placeholder="Enter Mii Studio code" required>
                                
                                <p style="color: var(--text-3); font-size: 0.9em; margin-top: 0.5rem;">
                                    ‚ÑπÔ∏è The Mii will be rendered locally after upload - no preview available before uploading.
                                </p>
                                
                                <label for="studio-description">Description (Max 250 characters):</label>
                                <textarea maxlength="250" rows="5" placeholder="Description..." name="desc" id="studio-description" required></textarea>
                                
                                <% if(isResearcher) { %>
                                    <div class="official-section">
                                        <input type="checkbox" name="official" id="officialCheckboxStudio" onchange="toggleOfficialFieldsStudio()"> 
                                        <label for="officialCheckboxStudio">
                                            <b>This is an exact copy of a Mii</b> that appears in a Nintendo game/promotion officially
                                        </label>
                                        
                                        <div id="officialFieldsStudio" style="display: none; margin-top: 15px; padding: 15px; background: #f0f8ff; border-radius: 8px; border: 2px solid #bbdefb;">
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                                <h4 style="margin: 0;">Official Mii Categories:</h4>
                                                <a href="/manageCategories" target="_blank" class="manage-cats-link">
                                                    üóÇÔ∏è Manage Categories
                                                </a>
                                            </div>
                                            
                                            <p style="color: #666; margin-bottom: 15px; font-size: 0.95em;">
                                                Select all categories that apply. Only leaf categories (those without children) can be selected.
                                            </p>
                                            
                                            <div id="categoriesContainerStudio">
                                                <p style="text-align: center; color: #666;">Loading categories...</p>
                                            </div>
                                            
                                            <p style="margin-top: 15px; font-size: 0.9em; color: #666;">
                                                <strong>Note:</strong> Please mention specific details in the description above.
                                                Incorrectly marking a Mii as official may result in it being removed.
                                            </p>
                                        </div>
                                    </div>
                                <% } %>
                                
                                <input type="submit" value="Upload from Studio">
                            </form>
                        </div>
                        
                        <!-- QR Scan Tab -->
                        <div id="qrTab" class="tab-content">
                            <p style="color: var(--text-2); margin-bottom: 1rem;">
                                Scan a 3DS/Wii U QR code directly using your device's camera.
                            </p>
                            <a href="/qr" class="btn btn-primary">Go to QR Scanner</a>
                        </div>
                    </fieldset>
                </article>
            <%- include('featuredMiis') %>
        </main>
        <%- include('footer') %>
        
        <script src="/upload.js"></script>
        <script>
            // Handle file upload form submission
            document.getElementById('uploadForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const submitBtn = this.querySelector('input[type="submit"]');
                const originalText = submitBtn.value;
                const errorDiv = document.getElementById('error-message');
                
                // Clear any previous error
                errorDiv.style.display = 'none';
                errorDiv.textContent = '';
                
                submitBtn.value = 'Uploading...';
                submitBtn.disabled = true;
                
                try {
                    const response = await fetch('/uploadMii', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (result.error) {
                        errorDiv.textContent = result.error;
                        errorDiv.style.display = 'block';
                    } else {
                        window.location.href = result.redirect;
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    errorDiv.textContent = 'An error occurred during upload. Please try again.';
                    errorDiv.style.display = 'block';
                } finally {
                    submitBtn.value = originalText;
                    submitBtn.disabled = false;
                }
            });

            // Handle studio form submission
            document.getElementById('studioForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const submitBtn = this.querySelector('input[type="submit"]');
                const originalText = submitBtn.value;
                const errorDiv = document.getElementById('error-message');
                
                // Clear any previous error
                errorDiv.style.display = 'none';
                errorDiv.textContent = '';
                
                submitBtn.value = 'Uploading...';
                submitBtn.disabled = true;
                
                try {
                    const response = await fetch('/uploadStudioMii', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (result.error) {
                        errorDiv.textContent = result.error;
                        errorDiv.style.display = 'block';
                    } else {
                        window.location.href = result.redirect;
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    errorDiv.textContent = 'An error occurred during upload. Please try again.';
                    errorDiv.style.display = 'block';
                } finally {
                    submitBtn.value = originalText;
                    submitBtn.disabled = false;
                }
            });
        </script>
    </body>
</html>