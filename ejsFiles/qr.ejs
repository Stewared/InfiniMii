<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Scanning QR - InfiniMii</title>
        <link rel="stylesheet" href="global.css">
        <link rel="stylesheet" href="utilityPages.css">
    </head>
    <body>
        <%- include('globalStyle') %>
        <%- include('header') %>
        <%- include('accountDisplay') %>
        <div class="content">
            <%- include('sidebar') %>
            <form method="POST" enctype="multipart/form-data" action="/convertMii" class="convert" hidden>
                <fieldset>
                    <legend>Convert</legend>
                    <input type="hidden" name="3dsbin" class="convert-bindata">
                    <input type="hidden" name="fromType" value="3DS Bin">
                    I want to convert 3DS Bin to a <select name="toType">
                        <option>Wii Mii</option>
                        <option>Special Wii Mii</option>
                        <option>Special 3DS Mii</option>
                    </select><br>
                    <input type="submit" value="Convert"><br>
                    <h6>*Note: 3DS to Wii conversions are not guaranteed to be perfect, the 3DS has more options
                        than the Wii does</h6>
                </fieldset>
            </form>
            
            <form action="/uploadMii" method="post" enctype="multipart/form-data" class='upload' hidden>
                <fieldset>
                    <legend>Upload a Mii to the Website</legend>
                    <input type="hidden" name="type" value="3dsbin">
                    <input type="hidden" name="3dsbin" class="upload-bindata">
                    <input size="50" placeholder="Description..." name="desc" type="text"><br>
                    <input type="checkbox" name="official"> 
                    <label for="official">This is a Mii that appears in a game by default officially (Please mention which in description). 
                    Checking or not checking this box falsely may result in the Mii being taken down. 
                    Will be attributed to Nintendo and not you if set as official.</label><br>
                    <input type="submit" value="Upload">
                </fieldset>
            </form>

            <div class="qr">
                <input type="button" value="Start Scanning" onclick="start(this)">

                <div class="after" hidden>
                    <input type="button" value="Upload Mii" onclick="after('upload')">
                    <input type="button" value="Convert Mii" onclick="after('convert')">
                    <input type="button" value="Scan Again" onclick="start()">
                </div>

                <div id="loadingMessage">ðŸŽ¥ Click the start button to begin scanning</div>
                <canvas id="canvas" hidden></canvas>
                <div id="output" hidden>
                    <div id="outputMessage">No QR code detected.</div>
                </div>
            </div>
            <%- include('featuredMiis') %>
        </div>
        <%- include('footer') %>
        <script src="./easy.qrcode.js" type="text/javascript" charset="utf-8"></script>
        <script src="./jsQR.js"></script>
        <script src="/global.js"></script>
        <script>
            var stored;
            var going = false;
            var video = document.createElement("video");
            var canvasElement = document.getElementById("canvas");
            var canvas = canvasElement.getContext("2d", { willReadFrequently: true });
            var loadingMessage = document.getElementById("loadingMessage");
            var outputContainer = document.getElementById("output");
            var outputMessage = document.getElementById("outputMessage");
            let camStream;
            
            function drawLine(begin, end, color) {
                canvas.beginPath();
                canvas.moveTo(begin.x, begin.y);
                canvas.lineTo(end.x, end.y);
                canvas.lineWidth = 4;
                canvas.strokeStyle = color;
                canvas.stroke();
            }

            function start(el) {
                if (el) {
                    el.hidden = true;
                }
                going = true;
                document.querySelector(".after").hidden = true;
                loadingMessage.hidden = false;
                canvasElement.hidden = true;
                outputContainer.hidden = true;
                
                navigator.mediaDevices.getUserMedia({ 
                    audio: false, 
                    video: { facingMode: "environment" } 
                }).then(function (stream) {
                    camStream = stream;
                    video.srcObject = stream;
                    video.setAttribute("playsinline", true);
                    video.play();
                    requestAnimationFrame(tick);
                }).catch(function(err) {
                    loadingMessage.innerText = "âŒ Camera access denied or not available";
                    console.error(err);
                });
            }
            
            function stop(bin) {
                console.log("QR Code scanned, binary data length:", bin.length);
                if (camStream) {
                    camStream.getTracks().forEach((track) => track.stop());
                }
                document.querySelector(".after").hidden = false;
                stored = bin;
                video.pause();
                going = false;
                outputMessage.innerText = "âœ… QR Code scanned successfully!";
            }
            
            function after(act) {
                // Convert binary data to bit string as expected by server
                var bitString = "";
                stored.forEach(byte => {
                    bitString += byte.toString(2).padStart(8, "0");
                });
                
                switch (act) {
                    case 'convert':
                        document.querySelector(".convert-bindata").value = bitString;
                        document.querySelector(".qr").hidden = true;
                        document.querySelector(".convert").hidden = false;
                        document.querySelector(".after").hidden = true;
                        
                        // Add AJAX handling to the convert form
                        document.querySelector(".convert").addEventListener('submit', async function(e) {
                            e.preventDefault();
                            
                            const formData = new FormData(this);
                            const submitBtn = this.querySelector('input[type="submit"]');
                            const originalText = submitBtn.value;
                            
                            submitBtn.value = 'Converting...';
                            submitBtn.disabled = true;
                            
                            try {
                                const response = await fetch('/convertMii', {
                                    method: 'POST',
                                    body: formData
                                });
                                
                                if (response.ok) {
                                    const contentType = response.headers.get('content-type');
                                    if (contentType && contentType.includes('application/json')) {
                                        const result = await response.json();
                                        if (result.error) {
                                            alert(result.error);
                                        }
                                    } else {
                                        // Handle file download
                                        const contentDisposition = response.headers.get('content-disposition');
                                        if (contentDisposition && contentDisposition.includes('attachment')) {
                                            const blob = await response.blob();
                                            const url = window.URL.createObjectURL(blob);
                                            const a = document.createElement('a');
                                            a.href = url;
                                            const filename = contentDisposition.split('filename=')[1].replace(/"/g, '');
                                            a.download = filename;
                                            document.body.appendChild(a);
                                            a.click();
                                            window.URL.revokeObjectURL(url);
                                            document.body.removeChild(a);
                                        }
                                    }
                                } else {
                                    const result = await response.json();
                                    alert(result.error || 'Conversion failed');
                                }
                            } catch (error) {
                                console.error('Conversion error:', error);
                                alert('An error occurred during conversion. Please try again.');
                            } finally {
                                submitBtn.value = originalText;
                                submitBtn.disabled = false;
                            }
                        });
                        break;
                        
                    case 'upload':
                        console.log("Uploading Mii");
                        document.querySelector(".upload-bindata").value = bitString;
                        document.querySelector(".qr").hidden = true;
                        document.querySelector(".upload").hidden = false;
                        document.querySelector(".after").hidden = true;
                        
                        // Add AJAX handling to the upload form
                        document.querySelector(".upload").addEventListener('submit', async function(e) {
                            e.preventDefault();
                            
                            const formData = new FormData(this);
                            const submitBtn = this.querySelector('input[type="submit"]');
                            const originalText = submitBtn.value;
                            
                            submitBtn.value = 'Uploading...';
                            submitBtn.disabled = true;
                            
                            try {
                                const response = await fetch('/uploadMii', {
                                    method: 'POST',
                                    body: formData
                                });
                                
                                const result = await response.json();
                                
                                if (result.error) {
                                    alert(result.error);
                                } else {
                                    window.location.href = result.redirect;
                                }
                            } catch (error) {
                                console.error('Upload error:', error);
                                alert('An error occurred during upload. Please try again.');
                            } finally {
                                submitBtn.value = originalText;
                                submitBtn.disabled = false;
                            }
                        });
                        break;
                }
            }

            function tick() {
                if (!going) return;
                
                loadingMessage.innerText = "âŒ› Loading video...";
                
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    loadingMessage.hidden = true;
                    canvasElement.hidden = false;
                    outputContainer.hidden = false;

                    canvasElement.height = video.videoHeight;
                    canvasElement.width = video.videoWidth;
                    canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
                    
                    var imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
                    var code = jsQR(imageData.data, imageData.width, imageData.height, {
                        inversionAttempts: "dontInvert",
                    });
                    
                    if (code) {
                        drawLine(code.location.topLeftCorner, code.location.topRightCorner, "#00FF00");
                        drawLine(code.location.topRightCorner, code.location.bottomRightCorner, "#00FF00");
                        drawLine(code.location.bottomRightCorner, code.location.bottomLeftCorner, "#00FF00");
                        drawLine(code.location.bottomLeftCorner, code.location.topLeftCorner, "#00FF00");
                        outputMessage.hidden = true;
                        stop(code.binaryData);
                    } else {
                        outputMessage.hidden = false;
                        outputMessage.innerText = "No QR code detected.";
                    }
                }
                requestAnimationFrame(tick);
            }
        </script>
    </body>
</html>